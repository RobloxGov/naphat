<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>แก้ไขรูปภาพ</title>
  <link rel="stylesheet" href="css/style.css">
</head>
<body>
  <header>
    <div class="container d-flex justify-content-between align-items-center">
      <h1>แก้ไขรูปภาพ</h1>
      <nav>
          <button class="bg-primary">
            <a href="index.html">หน้าหลัก</a>
          </button>
          <button class="bg-primary">
            <a href="#" id="logoutBtn"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-log-in mr-2 h-4 w-4"><path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"></path><polyline points="10 17 15 12 10 7"></polyline><line x1="15" x2="3" y1="12" y2="12"></line></svg>ออกจากระบบ</a>
          </button>
      </nav>
    </div>
  </header>

  <main>
    <form id="editForm">
      <input type="hidden" id="imageId">

      <div class="form-group">
        <label for="editImageTitle">ชื่อภาพ</label>
        <input type="text" id="editImageTitle" required>
      </div>

      <div class="form-group">
        <label for="editImageDescription">รายละเอียดภาพ</label>
        <textarea id="editImageDescription" required></textarea>
      </div>

      <div class="form-group">
        <label for="editImageLocation">สถานที่ (หมวดหมู่)</label>
        <input type="text" id="editImageLocation" list="editLocations" required>
        <datalist id="editLocations">
          <!-- Existing locations will be populated here -->
        </datalist>
      </div>

      <div class="form-group">
        <label>รูปภาพปัจจุบัน</label>
        <img id="currentImage" src="" alt="Current Image" style="max-width: 300px; display: block;">
      </div>

      <div class="form-group">
        <label for="newImageFile">เลือกรูปภาพใหม่ (หากต้องการเปลี่ยน)</label>
        <input type="file" id="newImageFile" accept="image/*">
      </div>

      <div class="button-group">
        <button type="submit">บันทึกการเปลี่ยนแปลง</button>
        <button type="button" id="deleteBtn">ลบรูปภาพ</button>
      </div>
    </form>
  </main>

  <script src="/js/auth.js"></script>
  <script src="/js/gsheet.js"></script>
  <script>
    // ฟังก์ชันดึงข้อมูลจาก URL
    function getUrlParameter(name) {
      name = name.replace(/[[]/, '\\[').replace(/[\]]/, '\\]');
      const regex = new RegExp('[\\?&]' + name + '=([^&#]*)');
      const results = regex.exec(location.search);
      return results === null ? '' : decodeURIComponent(results[1].replace(/\+/g, ' '));
    }

    // ฟังก์ชันโหลดข้อมูลรูปภาพ
    async function loadImageData() {
      const imageId = getUrlParameter('id');
      if (!imageId) {
        alert('ไม่พบ ID รูปภาพ');
        window.location.href = 'index.html';
        return;
      }

      try {
        // ดึงข้อมูลจาก Google Sheets
        const response = await fetch(`https://script.google.com/macros/s/AKfycbxyqZ1SuTMNddVFLom6B-jXxDV-WQOOKl_8XolTQkDYv6z0bzDFL9QMoikWl1kjWGFW/exec?action=getImage&id=${imageId}`);
        const imageData = await response.json();

        // แสดงข้อมูลในฟอร์ม
        document.getElementById('imageId').value = imageData.id;
        document.getElementById('editImageTitle').value = imageData.title;
        document.getElementById('editImageDescription').value = imageData.description;
        document.getElementById('editImageLocation').value = imageData.location;
        document.getElementById('currentImage').src = imageData.image;

        // โหลดหมวดหมู่ที่มีอยู่
        populateCategories();

      } catch (error) {
        console.error('Error loading image data:', error);
        alert('เกิดข้อผิดพลาดในการโหลดข้อมูลรูปภาพ');
      }
    }

    // ฟังก์ชันโหลดหมวดหมู่
    async function populateCategories() {
      try {
        const response = await fetch('YOUR_SCRIPT_URL?action=getCategories');
        const categories = await response.json();
        const datalist = document.getElementById('editLocations');
        
        datalist.innerHTML = '';
        categories.forEach(category => {
          const option = document.createElement('option');
          option.value = category;
          datalist.appendChild(option);
        });
      } catch (error) {
        console.error('Error loading categories:', error);
      }
    }

    // เมื่อหน้าเว็บโหลดเสร็จ
    document.addEventListener('DOMContentLoaded', () => {
      // ตรวจสอบการล็อกอิน
      if (localStorage.getItem('authenticated') !== 'true') {
        alert('กรุณาล็อกอินก่อนแก้ไขข้อมูล');
        window.location.href = 'login.html';
        return;
      }

      // โหลดข้อมูลรูปภาพ
      loadImageData();

      // อื่นๆ...
    });
  </script>
</body>
</html>
